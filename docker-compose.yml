version: '3.7'

x-web-defaults: &web-defaults
  restart: unless-stopped
  build:
    context: backend
    dockerfile: Dockerfile
  volumes:
    - ./backend:/app
    - ./frontend:/frontend
  depends_on:
    - redis
    - db
  environment:
    OCTOPRINT_TUNNEL_PORT_RANGE: '0-0'
    EMAIL_HOST: ''
    EMAIL_HOST_USER: ''
    EMAIL_HOST_PASSWORD: ''
    EMAIL_PORT: '587'
    EMAIL_USE_TLS: 'True'
    DEFAULT_FROM_EMAIL: 'changeme@example.com'
    DEBUG: 'False'
    ADMIN_IP_WHITELIST: ''
    SITE_USES_HTTPS: 'False'
    SITE_IS_PUBLIC: 'False'
    CSRF_TRUSTED_ORIGINS: ''
    SOCIAL_LOGIN: 'False'
    REDIS_URL: 'redis://redis:6379'
    DATABASE_URL: 'postgres://obico:obico@db:5432/obico'
    INTERNAL_MEDIA_HOST: 'http://web:3334'
    ML_API_HOST: 'http://ml_api:3333'
    ACCOUNT_ALLOW_SIGN_UP: 'False'
    WEBPACK_LOADER_ENABLED: 'False'
    DJANGO_SECRET_KEY: '2139cb7e6814e5ad7e145338964031acf66abce3d1f7f386e2cdd2cd4a8b42404599de602fd7646f2233231dba70b6969821'
    DJANGO_ALLOWED_HOSTS: '192.168.100.105,umbrel,umbrel.tailc9398a.ts.net,localhost,127.0.0.1'
    OBICO_AUTH_TOKEN: '655105'
    MOONRAKER_URL: 'http://moonraker:7125'
    VIDEO_STREAMING_BACKEND: 'janus'
    JANUS_URL: 'wss://umbrel.tailc9398a.ts.net/ws'
    JANUS_HTTP_URL: 'https://umbrel.tailc9398a.ts.net/janus'
    DISABLE_VIDEO_STREAMING: 'False'
    ONNXRUNTIME_DISABLE_GPU: '1'
    SITE_ID: '2'
    VERSION: 'local-build'

services:
  db:
    image: postgres:14
    hostname: db
    container_name: obico-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=obico
      - POSTGRES_PASSWORD=obico
      - POSTGRES_DB=obico
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - internal_net

  redis:
    image: redis:7.2-alpine
    hostname: redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      start_period: 15s
      interval: 15s
      timeout: 10s
      retries: 20
    networks:
      - internal_net

  ml_api:
    hostname: ml_api
    restart: unless-stopped
    build:
      context: ml_api
    environment:
      DEBUG: 'True'
      FLASK_APP: 'server.py'
    tty: true
    command: bash -c "gunicorn --bind 0.0.0.0:3333 --workers 1 wsgi"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider --no-check-certificate http://ml_api:3333/hc/"]
      start_period: 30s
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - internal_net

  web:
    <<: *web-defaults
    hostname: web
    ports:
      - "3334:3334"
    depends_on:
      - ml_api
      - db
      - redis
    command: sh -c "python manage.py migrate && python manage.py collectstatic -v 2 --noinput && daphne -b 0.0.0.0 -p 3334 asgi:application"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider --no-check-certificate http://web:3334/hc/"]
      start_period: 30s
      interval: 90s
      timeout: 20s
      retries: 3
    networks:
      - internal_net

  tasks:
    <<: *web-defaults
    hostname: tasks
    command: sh -c "celery -A config worker --beat -l info -c 2 -Q realtime,celery"
    healthcheck:
      test: ["CMD-SHELL", "celery -A config inspect ping"]
      start_period: 15s
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - internal_net

  moonraker:
    build: ./moonraker
    container_name: moonraker
    restart: unless-stopped
    ports:
      - "7125:7125"
    volumes:
      - ./moonraker_config:/home/klipper/config
      - /tmp:/tmp
    networks:
      - internal_net

  klipper:
    build: ./klipper
    container_name: klipper
    restart: unless-stopped
    volumes:
      - ./moonraker_config:/home/klipper/config
      - ./moonraker_config/logs:/home/klipper/logs
      - /tmp:/tmp
      - /dev:/dev
    devices:
      - "/dev/ttyUSB0:/dev/ttyUSB0"
    networks:
      - internal_net

volumes:
  db_data:
  redis_data:

networks:
  internal_net:
    driver: bridge
